# 업비트 자동매매 봇 - 현재 구현 계획서

## 📋 개요

서버 기반 Ollama를 활용한 분산 AI 자동매매 시스템으로, 3단계 선정 프로세스를 통해 최적의 매매 기회를 포착합니다.

## 🏗️ 시스템 아키텍처

### Ollama 구성
- **서버 Ollama (1.5b 모델)**: 코인 정보 수집 및 스캔
  - 위치: 서버 로컬 (`http://127.0.0.1:11434`)
  - 역할: 거래량 상위 50개 코인 지속적 스캔
  - 저장소: Redis
  - 스캔 간격: 1분 (서버 부하에 따라 조정 가능)

- **결정자 Ollama (1.5b 모델)**: 매매 결정
  - 위치: 서버 로컬 (동일 인스턴스)
  - 역할: 스캔 결과 분석 및 매매 신호 생성

### 데이터 흐름
```
서버 Ollama 1.5b → Redis → 결정자 Ollama 1.5b → 매매 실행
```

## 🎯 3단계 선정 프로세스

### 1차 선정: 거래량 상위 30개
- **기준**: 24시간 거래량 (KRW 마켓)
- **목적**: 유동성이 높은 코인만 선별
- **출력**: 30개 코인 리스트

### 2차 선정: 상위 10개
- **기준**: 
  - 점수 (score) 및 거래량
  - 보유 코인 제외
  - 고위험 제외 (일반 모드)
  - 최소 점수 필터링 (0.6 이상)
  - 거래량 상위 20개 중 점수 기준 상위 10개
- **출력**: 10개 코인 리스트
- **표시**: AI 분석 콘솔에 표시

### 3차 최종 선정: 상위 5개
- **기준**: 
  - 효과 점수 (score_eff) 기준 정렬
  - BTC 페널티 적용 (0.9배)
  - 포트폴리오 노출 비율 고려
  - 상위 5개 선정
- **출력**: 5개 코인 리스트
- **표시**: 매매 예정 콘솔에 표시 (반드시 5개 슬롯)
- **매매**: 조건에 맞는 시그널 발생 시 진행

## 📊 대시보드 콘솔 구성

### 1. AI 분석 콘솔 (2차 선정 10개)
- **목적**: 선정 과정 및 분석 결과 표시
- **표시 내용**:
  - 선정 과정 요약 (1차 30개 → 2차 10개)
  - 각 코인의 기본점수, 효과점수
  - 트렌드 (상승/하락/횡보)
  - 리스크 레벨
  - 포트폴리오 노출 비율
  - 분석 이유
- **최종 결정 표시**: ❌ 제거됨

### 2. 매매 예정 콘솔 (최종 선정 5개)
- **목적**: 실제 매매 대상 및 시그널 표시
- **표시 내용**:
  - 반드시 5개 슬롯 표시 (부족하면 "대기 중" 표시)
  - 각 코인의 기본점수, 효과점수
  - 트렌드 및 리스크
  - **매수/매도 시그널 상태**:
    - 🟢 매수 시그널 발생 (선택된 코인)
    - 🔴 매도 시그널 발생 (선택된 코인)
    - ⚪ 대기 중 (선택된 코인, HOLD)
    - ⏸️ 대기 중 (다른 후보)
  - 최종 결정 요약 (매매 신호, 신뢰도, 가격, 변동성, 거래량)

## 🔧 기술 스택

### 백엔드
- **FastAPI**: 웹 서버 및 API
- **Ollama**: 로컬 LLM (qwen2.5:1.5b)
- **Redis**: 스캔 결과 저장소
- **SQLite**: 거래 내역 및 포지션 관리
- **Upbit API**: 거래 실행

### 프론트엔드
- **Server-Sent Events (SSE)**: 실시간 데이터 스트리밍
- **JavaScript**: 동적 UI 업데이트
- **Tailwind CSS**: 스타일링

## 🔄 주요 기능

### 1. 연속 스캔 서비스
- **위치**: `scripts/start_scanner.py`
- **기능**: 
  - 거래량 상위 50개 코인 지속적 스캔
  - Redis에 결과 저장
  - 서버 부하에 따른 적응형 스캔 간격

### 2. 매매 결정 엔진
- **위치**: `upbit_bot/services/trading_decision.py`
- **기능**:
  - 3단계 선정 프로세스 실행
  - 효과 점수 계산 (BTC 페널티, 노출 비율 고려)
  - 매매 신호 생성

### 3. 대시보드
- **위치**: `upbit_bot/web/app.py`
- **기능**:
  - 실시간 분석 결과 표시
  - 두 개의 콘솔로 역할 분리
  - 매매 시그널 상태 표시

## 📝 환경 변수

```bash
# Ollama 설정
OLLAMA_BASE_URL=http://127.0.0.1:11434  # 서버 로컬 Ollama
OLLAMA_SCANNER_MODEL=qwen2.5:1.5b
OLLAMA_DECISION_MODEL=qwen2.5:1.5b

# Redis 설정
REDIS_URL=redis://localhost:6379/0

# 분산 모드
USE_DISTRIBUTED_SCANNER=true
SCANNER_API_URL=http://localhost:8080/api/scan-results

# Upbit API
UPBIT_ACCESS_KEY=your_access_key
UPBIT_SECRET_KEY=your_secret_key
```

## 🚀 실행 방법

### 1. 스캐너 서비스 시작
```bash
python3 -m scripts.start_scanner
```

### 2. 대시보드 서버 시작
```bash
python3 -m uvicorn upbit_bot.web.app:create_app --factory --host 0.0.0.0 --port 8080
```

### 3. 대시보드 접속
```
http://localhost:8080
```

## 📈 선정 프로세스 상세

### 1차: 거래량 상위 30개
- Upbit API에서 24시간 거래량 기준 상위 30개 코인 조회
- KRW 마켓만 대상

### 2차: 상위 10개 선정
1. 보유 코인 제외
2. 고위험 제외 (일반 모드)
3. 최소 점수 필터링 (0.6 이상)
4. 거래량 기준 정렬
5. 상위 20개에서 점수 기준 재정렬
6. 최종 10개 선정

### 3차: 최종 5개 선정
1. 효과 점수 계산:
   - 기본 점수 (base_score)
   - BTC 페널티 적용 (0.9배)
   - 포트폴리오 노출 비율 고려
   - 효과 점수 (score_eff) = base_score × BTC_페널티 × 노출_페널티
2. 효과 점수 기준 정렬
3. 상위 5개 선정
4. 최고 점수 코인 선택 (실제 매매 대상)

## 🎨 UI 구성

### AI 분석 콘솔
- **색상**: 녹색 계열
- **표시**: 2차 선정 10개 코인
- **정보**: 점수, 트렌드, 리스크, 이유

### 매매 예정 콘솔
- **색상**: 파란색 계열
- **표시**: 최종 선정 5개 코인 (반드시 5개 슬롯)
- **정보**: 
  - 점수, 트렌드, 리스크
  - 매수/매도 시그널 상태
  - 최종 결정 요약

## 🔍 주요 개선사항

### 최근 변경사항
1. ✅ 노트북 Ollama 제거 → 서버 로컬 Ollama 사용
2. ✅ 3단계 선정 프로세스 명확화
3. ✅ 콘솔 역할 분리 (분석 vs 매매 예정)
4. ✅ 매매 예정 콘솔에 반드시 5개 표시
5. ✅ 각 코인의 매수/매도 시그널 상태 표시
6. ✅ 최종 결정은 매매 예정 콘솔에만 표시

## 📌 향후 개선 방향

1. **성능 최적화**
   - Ollama 요청 타임아웃 최적화
   - 스캔 간격 동적 조정

2. **기능 확장**
   - 다중 전략 지원
   - 백테스팅 기능
   - 알림 시스템 강화

3. **모니터링**
   - 실시간 성능 지표
   - 오류 추적 및 알림
   - 로그 분석 도구

## 📚 관련 문서

- `DUAL_OLLAMA_IMPLEMENTATION.md`: 이중 Ollama 구현 상세
- `OLLAMA_VERSION_REQUIREMENTS.md`: Ollama 버전 호환성
- `PROJECT_ANALYSIS.md`: 프로젝트 분석 문서

